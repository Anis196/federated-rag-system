<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Restaurant Assistant — Chat</title>
    <style>
      :root{
        --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --you:#0ea5a4; --bot:#7dd3fc;
      }
      html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
      body{background:linear-gradient(180deg,#071428 0%, #041025 100%);display:flex;align-items:center;justify-content:center;padding:24px}
      .container{width:100%;max-width:900px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.7);overflow:hidden}
      header{display:flex;align-items:center;gap:12px;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,0.03)}
      header h1{margin:0;font-size:18px;color:#e6eef8}
      header p{margin:0;color:var(--muted);font-size:13px}
      .chat-area{display:flex;flex-direction:column;height:72vh;min-height:420px}
      .messages{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
      .bubble{max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.4;font-size:14px;color:#07203a;word-wrap:break-word}
      .row{display:flex;align-items:flex-end}
      .row.you{justify-content:flex-end}
      .you .bubble{background:linear-gradient(90deg,var(--you),#06b6d4);color:#04202a;border-bottom-right-radius:6px}
      .bot .bubble{background:linear-gradient(90deg,#e6f6ff,var(--bot));color:#042034;border-bottom-left-radius:6px}
      .meta{font-size:12px;color:var(--muted);margin-top:6px}
      .composer{display:flex;padding:14px;border-top:1px solid rgba(255,255,255,0.03);gap:10px}
      .composer input{flex:1;padding:12px 14px;border-radius:10px;border:none;background:#071422;color:#dff3fb;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
      .composer button{background:var(--accent);border:none;color:#042028;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
      .composer button[disabled]{opacity:.6;cursor:not-allowed}
      .typing{height:12px;width:44px;display:inline-block}
      .dot{height:8px;width:8px;background:#0b1220;border-radius:50%;display:inline-block;margin:0 3px;animation:blink 1s infinite}
      .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
      @keyframes blink{0%{opacity:.15}50%{opacity:1}100%{opacity:.15}}
      .small{font-size:12px;color:var(--muted)}
      @media (max-width:600px){.container{border-radius:8px}.composer input{padding:10px}.header h1{font-size:16px}}
    </style>
  </head>
  <body>
    <div class="container" role="application" aria-label="Restaurant assistant chat">
      <header>
        <div>
          <h1>Restaurant Assistant</h1>
          <p>Ask about forecasts, top items, or demand planning — friendly, concise answers.</p>
        </div>
      </header>
      <main class="chat-area">
        <div id="messages" class="messages" aria-live="polite"></div>
        <form id="composer" class="composer" autocomplete="off">
          <input id="inputMessage" name="message" placeholder="Type your question, e.g. 'What's the top item this week?'" aria-label="Message" />
          <button id="sendBtn" type="submit">Send</button>
        </form>
      </main>
    </div>

    <script>
      (function(){
        const messagesEl = document.getElementById('messages');
        const form = document.getElementById('composer');
        const input = document.getElementById('inputMessage');
        const sendBtn = document.getElementById('sendBtn');

        function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

        function createRow(role, text, opts){
          const row = document.createElement('div');
          row.className = 'row ' + (role==='you' ? 'you' : 'bot');
          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          bubble.innerHTML = text || '';
          row.appendChild(bubble);
          const meta = document.createElement('div');
          meta.className = 'meta small';
          meta.textContent = role === 'you' ? 'You' : 'Assistant';
          const wrapper = document.createElement('div');
          wrapper.appendChild(row);
          wrapper.appendChild(meta);
          messagesEl.appendChild(wrapper);
          scrollToBottom();
          return {row,bubble};
        }

        function showTyping(){
          const typingWrap = document.createElement('div');
          typingWrap.className = 'row bot typing-row';
          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          bubble.innerHTML = '<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
          typingWrap.appendChild(bubble);
          messagesEl.appendChild(typingWrap);
          scrollToBottom();
          return typingWrap;
        }

        async function sendMessage(text){
          // show user message
          createRow('you', escapeHtml(text));
          input.value = '';
          input.focus();
          sendBtn.disabled = true;

          const typingEl = showTyping();

          try{
            const body = 'message=' + encodeURIComponent(text);
            const resp = await fetch('/api/rag/chat', {
              method: 'POST',
              headers: {'Content-Type':'application/x-www-form-urlencoded'},
              body
            });
            const json = await resp.json();
            const ans = (json && json.answer) ? json.answer : null;
            // remove typing indicator
            typingEl.remove();
            if(!ans){
              createRow('bot', 'Sorry — I could not find an answer right now. Try rephrasing or check the server.');
            } else {
              createRow('bot', ans);
            }
          }catch(err){
            try{ typingEl.remove(); }catch(e){}
            createRow('bot', '[Error] ' + (err && err.message ? err.message : String(err)));
          }finally{
            sendBtn.disabled = false;
          }
        }

        function escapeHtml(str){
          if(!str) return '';
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const txt = input.value && input.value.trim();
          if(!txt) return;
          sendMessage(txt);
        });

        // allow Enter to send, Shift+Enter for newline
        input.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); form.dispatchEvent(new Event('submit',{cancelable:true})); }
        });

        // welcome message
        createRow('bot', 'Hi — I can help with forecasts, top items, and demand planning. Ask me anything about the CSV/XLS data.');
      })();
    </script>
  </body>
</html>


